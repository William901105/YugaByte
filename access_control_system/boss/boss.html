<!--
此頁面為主管系統的主頁面
功能：
1. 查詢特定員工的打卡紀錄和薪資紀錄
2. 查詢所有員工的打卡紀錄和薪資紀錄
3. 包含登出功能
4. 具備身份驗證檢查（未登入自動導向登入頁）
-->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主管管理系統</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>主管管理系統</h1>        <ul class="menu">
            <li><a href="boss-employee-search.html">查詢特定員工資料</a></li>
            <li><a href="boss-all-records.html">查看所有員工打卡紀錄</a></li>
            <li><a href="boss-all-salary.html">查看所有員工薪資紀錄</a></li>
            <li><button id="logoutButton">登出</button></li>
        </ul>
        <p id="mqttStatus" style="color: red; display: none;">MQTT 連線失敗，請檢查網路或稍後再試。</p>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const userId = localStorage.getItem('user_id');
            const accessToken = localStorage.getItem('access_token');

            if (!userId || !accessToken) {
                alert('未登入，請重新登入');
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('logoutButton').addEventListener('click', function () {
                localStorage.clear();
                window.location.href = 'index.html';
            });

            // MQTT 客戶端初始化
            const client = new Paho.MQTT.Client('broker.hivemq.com', 8000, `clientId-${Math.random().toString(16).substr(2, 8)}`);

            // 當收到訊息時的處理函數
            client.onMessageArrived = function (message) {
                console.log('收到員工異常通知:', message.payloadString);
                alert(`員工異常通知: ${message.payloadString}`);
            };

            // 設定重連參數
            let reconnectCount = 0;
            const maxReconnectAttempts = 5;
            const reconnectDelay = 3000; // 3 秒

            function connectMQTT() {
                client.connect({
                    onSuccess: function() {
                        console.log('MQTT 連線成功');
                        document.getElementById('mqttStatus').style.display = 'none';
                        reconnectCount = 0;
                        // 訂閱所有員工的異常通知
                        client.subscribe('access_control/alerts/all', {
                            onSuccess: function () {
                                console.log('訂閱成功');
                            },
                            onFailure: function (error) {
                                console.error('訂閱失敗:', error.errorMessage);
                                document.getElementById('mqttStatus').style.display = 'block';
                            }
                        });
                    },
                    onFailure: function(error) {
                        console.error('MQTT 連線失敗:', error.errorMessage);
                        document.getElementById('mqttStatus').style.display = 'block';
                        if (reconnectCount < maxReconnectAttempts) {
                            reconnectCount++;
                            console.log(`嘗試重新連線 (${reconnectCount}/${maxReconnectAttempts})...`);
                            setTimeout(connectMQTT, reconnectDelay);
                        }
                    }
                });
            }

            // 當連線中斷時的處理函數
            client.onConnectionLost = function (responseObject) {
                if (responseObject.errorCode !== 0) {
                    console.error('MQTT 連線中斷:', responseObject.errorMessage);
                    document.getElementById('mqttStatus').style.display = 'block';
                    if (reconnectCount < maxReconnectAttempts) {
                        reconnectCount++;
                        console.log(`嘗試重新連線 (${reconnectCount}/${maxReconnectAttempts})...`);
                        setTimeout(connectMQTT, reconnectDelay);
                    }
                }
            };

            // 初始連線
            connectMQTT();
        });
    </script>
</body>
</html>
