<!--
此頁面為主管查看所有員工打卡紀錄的頁面
功能：
1. 顯示所有員工的打卡統計
2. 提供詳細資料查看功能
3. 具備身份驗證檢查
4. 包含返回主選單功能
-->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>所有員工打卡紀錄</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>所有員工打卡紀錄</h1>

        <!-- 日期範圍選擇 -->
        <div class="search-section">
            <div class="form-group">
                <div class="date-range">
                    <input type="date" id="startDate" placeholder="開始日期">
                    <input type="date" id="endDate" placeholder="結束日期">
                </div>
                <button id="searchButton">查詢</button>
            </div>
        </div>

        <!-- 統計資料表格 -->
        <div class="records-section">
            <table>
                <thead>
                    <tr>
                        <th>員工帳號</th>
                        <th>本月出勤率</th>
                        <th>正常打卡次數</th>
                        <th>異常打卡次數</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="recordsTable">
                </tbody>
            </table>
        </div>

        <!-- 返回按鈕 -->
        <div class="button-group">
            <button onclick="window.location.href='boss.html'" class="back-button">返回主選單</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 驗證登入狀態
            const userId = localStorage.getItem('user_id');
            if (!userId) {
                alert('未登入，請重新登入');
                window.location.href = 'index.html';
                return;
            }

            const searchButton = document.getElementById('searchButton');
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');

            // 初始加載
            loadAllEmployeesRecords();

            // 查詢按鈕點擊事件
            searchButton.addEventListener('click', loadAllEmployeesRecords);

            function loadAllEmployeesRecords() {
                const userId = localStorage.getItem('user_id');
                const accessToken = localStorage.getItem('access_token');

                if (!userId || !accessToken) {
                    alert('未登入或登入已過期，請重新登入');
                    window.location.href = 'index.html';
                    return;
                }

                // 構建查詢 URL
                let url = 'http://localhost:5001/api/boss/employees_info';
                if (startDate.value && endDate.value) {
                    url += `?start_date=${startDate.value}&end_date=${endDate.value}`;
                }

                fetch(url, {
                    headers: {
                        'Authorization': accessToken,
                        'X-User-ID': userId
                    }
                })
                .then(res => {
                    if (res.status === 401) {
                        // Token 過期，嘗試刷新
                        const refreshToken = localStorage.getItem('refresh_token');
                        return fetch('http://localhost:5000/authorization/refreshToken', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                refresh_token: refreshToken,
                                user_id: userId
                            })
                        }).then(refreshRes => {
                            if (!refreshRes.ok) {
                                throw new Error('重新整理認證失敗');
                            }
                            return refreshRes.json();
                        }).then(tokens => {
                            // 儲存新的 tokens
                            localStorage.setItem('access_token', tokens.new_access_token);
                            localStorage.setItem('refresh_token', tokens.new_refresh_token);
                            
                            // 重新發送原始請求
                            return fetch(url, {
                                headers: {
                                    'Authorization': tokens.new_access_token,
                                    'X-User-ID': userId
                                }
                            });
                        });
                    }
                    return res;
                })
                .then(res => res.json())
                .then(result => {
                    if (result.status !== 'success' || !result.data) {
                        updateRecordsTable([]);
                        return;
                    }
                    updateRecordsTable(result.data);
                })
                .catch(error => {
                    console.error('獲取資料失敗:', error);
                    alert('獲取資料失敗，請稍後再試');
                });
            }

            function updateRecordsTable(data) {
                const tbody = document.getElementById('recordsTable');
                tbody.innerHTML = data.length ? data.map(record => {
                    // 計算出勤統計
                    const clockInCount = record.clock_records['上班'].length;
                    const clockOutCount = record.clock_records['下班'].length;
                    const normalCount = Math.min(clockInCount, clockOutCount);
                    const abnormalCount = Math.abs(clockInCount - clockOutCount);
                    const attendanceRate = startDate.value && endDate.value ? 
                        calculateAttendanceRate(record.clock_records, startDate.value, endDate.value) :
                        '需選擇日期範圍';

                    return `
                    <tr>
                        <td>${record.user_id}</td>
                        <td>${attendanceRate}</td>
                        <td>${normalCount}</td>
                        <td>${abnormalCount}</td>
                        <td>
                            <button onclick="window.location.href='boss-employee-search.html?account=${record.user_id}'">
                                查看詳細
                            </button>
                        </td>
                    </tr>
                `}).join('') : '<tr><td colspan="5">無員工資料</td></tr>';
            }            function calculateAttendanceRate(clockRecords, start, end) {
                const startDate = new Date(start);
                const endDate = new Date(end);
                let workDayCount = 0;
                let actualWorkDays = 0;

                // 計算工作日總數（排除週末）
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    if (d.getDay() !== 0 && d.getDay() !== 6) { // 0是週日，6是週六
                        workDayCount++;
                    }
                }

                // 計算實際出勤天數（排除週末）
                actualWorkDays = clockRecords['上班'].filter(time => {
                    const date = new Date(time);
                    const isWorkDay = date.getDay() !== 0 && date.getDay() !== 6;
                    return date >= startDate && date <= endDate && isWorkDay;
                }).length;
                
                if (workDayCount === 0) return '0%';
                return `${Math.round((actualWorkDays / workDayCount) * 100)}%`;
            }
        });
    </script>
</body>
</html>
