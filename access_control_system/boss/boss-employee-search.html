<!--
此頁面為主管查詢特定員工資料的頁面
功能：
1. 提供員工帳號搜尋功能
2. 顯示員工的打卡紀錄和薪資紀錄
3. 具備身份驗證檢查
4. 包含返回主選單功能
-->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>員工資料查詢</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>員工資料查詢</h1>
        
        <!-- 搜尋區塊 -->
        <div class="search-section">
            <div class="form-group">
                <input type="text" id="employeeAccount" placeholder="輸入員工帳號">
                <div class="date-range">
                    <input type="date" id="startDate" placeholder="開始日期">
                    <input type="date" id="endDate" placeholder="結束日期">
                </div>
                <button id="searchButton">查詢</button>
            </div>
        </div>

        <!-- 查詢結果 -->
        <div class="results-section" style="display: none;">
            <h2>查詢結果</h2>
            
            <!-- 打卡紀錄 -->
            <div class="record-section">
                <h3>打卡紀錄</h3>
                <table>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>上班時間</th>
                            <th>下班時間</th>
                            <th>狀態</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTable">
                    </tbody>
                </table>
            </div>

            <!-- 薪資紀錄 -->
            <div class="salary-section">
                <h3>薪資紀錄</h3>
                <table>
                    <thead>
                        <tr>
                            <th>月份</th>
                            <th>基本薪資</th>
                            <th>加班費</th>
                            <th>總計</th>
                        </tr>
                    </thead>
                    <tbody id="salaryTable">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 返回按鈕 -->
        <div class="button-group">
            <button onclick="window.location.href='boss.html'" class="back-button">返回主選單</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 驗證登入狀態
            const userId = localStorage.getItem('user_id');
            if (!userId) {
                alert('未登入，請重新登入');
                window.location.href = 'index.html';
                return;
            }

            const searchButton = document.getElementById('searchButton');
            const employeeAccount = document.getElementById('employeeAccount');
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            const resultsSection = document.querySelector('.results-section');

            // 自動帶入 URL 參數 account
            const urlParams = new URLSearchParams(window.location.search);
            const accountParam = urlParams.get('account');
            if (accountParam) {
                employeeAccount.value = accountParam;
                searchEmployee();
            }

            // 查詢按鈕點擊事件
            searchButton.addEventListener('click', searchEmployee);

            function searchEmployee() {
                if (!employeeAccount.value) {
                    alert('請輸入員工帳號');
                    return;
                }

                const userId = localStorage.getItem('user_id');
                const accessToken = localStorage.getItem('access_token');

                if (!userId || !accessToken) {
                    alert('未登入或登入已過期，請重新登入');
                    window.location.href = 'index.html';
                    return;
                }

                // 顯示結果區域
                resultsSection.style.display = 'block';

                // 查詢單一員工資料
                fetch(`http://localhost:5001/api/boss/employees_info?user_id=${employeeAccount.value}`, {
                    headers: {
                        'Authorization': accessToken,
                        'X-User-ID': userId
                    }
                })
                .then(res => {
                    if (res.status === 401) {
                        // Token 過期，嘗試刷新
                        const refreshToken = localStorage.getItem('refresh_token');
                        return fetch('http://localhost:5000/authorization/refreshToken', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                refresh_token: refreshToken,
                                user_id: userId
                            })
                        }).then(refreshRes => {
                            if (!refreshRes.ok) {
                                throw new Error('重新整理認證失敗');
                            }
                            return refreshRes.json();
                        }).then(tokens => {
                            // 儲存新的 tokens
                            localStorage.setItem('access_token', tokens.new_access_token);
                            localStorage.setItem('refresh_token', tokens.new_refresh_token);
                            
                            // 重新發送原始請求
                            return fetch(`http://localhost:5001/api/boss/employees_info?user_id=${employeeAccount.value}`, {
                                headers: {
                                    'Authorization': tokens.new_access_token,
                                    'X-User-ID': userId
                                }
                            });
                        });
                    }
                    return res;
                })
                .then(res => res.json())
                .then(result => {
                    if (result.status !== 'success' || !result.data || result.data.length === 0) {
                        alert('查無此員工或查詢失敗');
                        updateAttendanceTable([]);
                        updateSalaryTable([]);
                        return;
                    }
                    const emp = result.data[0];
                    
                    // 處理打卡紀錄
                    const attendance = [];
                    if (emp.clock_records) {
                        for (let i = 0; i < emp.clock_records['上班'].length; i++) {
                            const clockIn = emp.clock_records['上班'][i];
                            const clockOut = emp.clock_records['下班'][i] || '';
                            const clockInDate = new Date(clockIn);
                            attendance.push({
                                date: clockInDate.toLocaleDateString(),
                                clockIn: clockInDate.toLocaleTimeString(),
                                clockOut: clockOut ? new Date(clockOut).toLocaleTimeString() : '尚未下班',
                                status: '正常'
                            });
                        }
                    }
                    updateAttendanceTable(attendance);

                    // 處理薪資資料
                    const salary = [{
                        month: new Date().toLocaleDateString().slice(0, 7),
                        baseSalary: emp.salary,
                        overtime: 0,
                        total: emp.salary
                    }];
                    updateSalaryTable(salary);
                })
                .catch(error => {
                    console.error('獲取數據失敗:', error);
                    alert('獲取數據失敗，請稍後再試');
                });
            }

            // 更新打卡記錄表格
            function updateAttendanceTable(data) {
                const tbody = document.getElementById('attendanceTable');
                tbody.innerHTML = data.length ? data.map(record => `
                    <tr>
                        <td>${record.date}</td>
                        <td>${record.clockIn}</td>
                        <td>${record.clockOut}</td>
                        <td>${record.status}</td>
                    </tr>
                `).join('') : '<tr><td colspan="4">無打卡紀錄</td></tr>';
            }

            // 更新薪資記錄表格
            function updateSalaryTable(data) {
                const tbody = document.getElementById('salaryTable');
                tbody.innerHTML = data.map(record => `
                    <tr>
                        <td>${record.month}</td>
                        <td>${record.baseSalary}</td>
                        <td>${record.overtime}</td>
                        <td>${record.total}</td>
                    </tr>
                `).join('');
            }
        });
    </script>
</body>
</html>
